<!DOCTYPE html>
<html>
<head>
	<title>test</title>
</head>
<body>
<video controls></video>
<button onclick="play()">play</button>

<script src="util.js"></script>
<script src="mp4-remuxer.js"></script>
<script src="mp4-generator.js"></script>
<script>


var video = document.querySelector('video');
//var mimeCodec = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
//var mimeCodec = 'video/mp4; codecs=avc1.640015';
//var mimeCodec = 'video/mp4; codecs=avc1.42001f;';
var mimeCodec = 'video/mp4; codecs=avc1.42E01E;';
var sourceBuffer;

function init(){
	if ('MediaSource' in window && MediaSource.isTypeSupported(mimeCodec)) {
		var mediaSource = new MediaSource;

		video.src = URL.createObjectURL(mediaSource);
		console.log(mediaSource);
		console.log("video.src:"+video.src);

		mediaSource.addEventListener('sourceopen', sourceOpen);
		mediaSource.addEventListener('sourceended', sourceEnded);
		mediaSource.addEventListener('sourceclose', sourceClose);

	} else {
		console.error('Unsupported MIME type or codec: ', mimeCodec);
	}
}

function sourceOpen (_) {
	console.log("function:sourceOpen");
	mediaSource = this;
	sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
	//sourceBuffer.mode="sequence";
	sourceBuffer.mode="segments";
	console.log(mediaSource);
	console.log("mediaSource.readyState:" + mediaSource.readyState);
	console.log(sourceBuffer);
}
function sourceEnded(){
	console.log("function:sourceEnded");
}
function sourceClose(){
	console.log("function:sourceClose");
}

init();


var ws = new WebSocket("ws://10.129.27.249:8887/echo");

ws.onopen = function(evt) { 
  console.log("Connection open ..."); 
  ws.send("Hello WebSockets!");
};

ws.onmessage = function(evt) {	
	//var data = "{\"id\":1,\"type\":\"video\",\"codecWidth\":600,\"codecHeight\":800,\"duration\":3000,\"timescale\":1000,\"presentWidth\":600,\"presentHeight\":800,\"avcc\":\"AUIAH\/\/hAA5nQoAf2gJgZeXgG0KE1AEABGjOBuI=\"}";
	
	var data = JSON.parse(evt.data);
	console.log( "Received Message: " + data.cmd);  
	
	if("init"==data.cmd){
		
		handleInitData(data);
	}else{//media
		//var frameData="";
		handleMediaData(data);
	}
	
};

ws.onclose = function(evt) {
  console.log("Connection closed.");
}

var ftyp;
var moov;
var moof;
var mdat;

function handleInitData(initData){
	console.log("ftyp-----------------------------");
	ftyp = MP4.box(MP4.types.ftyp, MP4.constants.FTYP);
	console.log(ftyp);
	
	var meta=initData;
	meta.avcc = Util.str2ab(window.atob(meta.avcc));
	console.log(meta);

	moov = MP4.moov(meta);
	console.log("moov-----------------------------");
	console.log(moov);
}

function prepareSourceBuffer(){
	console.log("prepareSourceBuffer");
	
	console.log("ftyp-----------------------");	
	console.log(ftyp);
	console.log("moov-----------------------");
	console.log(moov);
	
	console.log("mdat-----------------------");	
	console.log(mdat);
	console.log("moof-----------------------");
	console.log(moof);
	
	var buf = Util.mergeBox(ftyp, moov, moof, mdat);
	Util.printFmp4Box(buf);
	Util.saveAs(new Blob([buf]), 'android.mp4');
	
	sourceBuffer.addEventListener('updateend', function (_) {
			console.log("updateend");

			
	});

	sourceBuffer.appendBuffer(buf);
	console.log(sourceBuffer);
	
}


function handleMediaData(framesData){	
	
	var mp4Samples = Util.parseMp4Samples(framesData);
	console.log(mp4Samples);
	
	mdat = Util.mdat(mp4Samples);
	moof = Util.moof(mp4Samples);	
	
	prepareSourceBuffer();
}

function play(){
	video.play();
}	


</script>
</body>
</html>